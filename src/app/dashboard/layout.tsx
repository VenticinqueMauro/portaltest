import Sidebar from "@/components/dashboard/layout/Sidebar";
import { NewsStatus, NewsType } from "@/types/news.types";
import { decodeToken } from "@/utils/utils";
import { Metadata } from "next";
import { Toaster } from 'sonner';
import { getProfile } from "./perfil/page";

export const metadata: Metadata = {
    title: 'Admin Panel | Noticias',
    description: 'Generated by create next app',
}

async function getPendingNews() {
    try {
        const response = await fetch(`${process.env.NEXT_PUBLIC_URL}api/news`);

        if (!response.ok) {
            throw new Error('OcurriÃ³ un error al consultar las noticias');
        }

        const { data }: { data: NewsType[] } = await response.json();

        return data.some((news) => news.status === NewsStatus.PENDING);

    } catch (error) {
        console.error(error);
        return false;
    }
}


export default async function layout({ children }: { children: React.ReactNode }) {

    const token = decodeToken();

    const { data: user } = await getProfile(token.id)

    const hasPendingNews = await getPendingNews();

    return (
        <section className="min-h-screen bg-background text-foreground relative flex">
            <Sidebar hasPendingNews={hasPendingNews} user={user} />
            <div className="flex-1 ml-[200px] overflow-y-auto p-6">
                {children}
            </div>
            <Toaster />
        </section>
    )
}